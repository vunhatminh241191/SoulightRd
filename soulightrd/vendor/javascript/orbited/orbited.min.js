(function(){var HANDSHAKE_TIMEOUT=30000;var RETRY_INTERVAL=250;var RETRY_TIMEOUT=30000;Orbited={};Orbited.settings={};Orbited.settings.hostname=document.domain;Orbited.settings.port=(location.port.length>0)?location.port:80;Orbited.settings.protocol=location.protocol.slice(0,-1);Orbited.settings.log=false;Orbited.settings.streaming=true;Orbited.settings.HEARTBEAT_TIMEOUT=6000;Orbited.settings.POLL_INTERVAL=2000;Orbited.settings.pageLoggerHeight="200px";Orbited.settings.pageLoggerWidth=null;Orbited.settings.enableFFPrivileges=false;Orbited.singleton={};Orbited.Errors={};Orbited.Errors.ConnectionTimeout=101;Orbited.Errors.InvalidHandshake=102;Orbited.Errors.UserConnectionReset=103;Orbited.Errors.Unauthorized=106;Orbited.Errors.RemoteConnectionFailed=108;Orbited.Statuses={};Orbited.Statuses.ServerClosedConnection=201;Orbited.Statuses.SocketControlKilled=301;Orbited.util={};Orbited.util.browser=null;if(typeof(ActiveXObject)!="undefined"){Orbited.util.browser="ie"}else{if(navigator.userAgent.indexOf("WebKit")!=-1||navigator.userAgent.indexOf("Konqueror")!=-1){Orbited.util.browser="webkit"}else{if(navigator.product=="Gecko"&&window.find&&!navigator.savePreferences){Orbited.util.browser="firefox"}else{if((typeof window.addEventStream)==="function"){Orbited.util.browser="opera"}}}}(function(){Orbited.base64={};var p="=";var tab="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";if(window.btoa&&window.btoa("1")=="MQ=="){Orbited.base64.encode=function(data){return btoa(data)};Orbited.base64.decode=function(data){return atob(data)};return}Orbited.base64.encode=function(ba){var s=[];var l=ba.length;var rm=l%3;var x=l-rm;for(var i=0;i<x;){var t=ba.charCodeAt(i++)<<16|ba.charCodeAt(i++)<<8|ba.charCodeAt(i++);s.push(tab.charAt((t>>>18)&63));s.push(tab.charAt((t>>>12)&63));s.push(tab.charAt((t>>>6)&63));s.push(tab.charAt(t&63))}switch(rm){case 2:t=ba.charCodeAt(i++)<<16|ba.charCodeAt(i++)<<8;s.push(tab.charAt((t>>>18)&63));s.push(tab.charAt((t>>>12)&63));s.push(tab.charAt((t>>>6)&63));s.push(p);break;case 1:t=ba.charCodeAt(i++)<<16;s.push(tab.charAt((t>>>18)&63));s.push(tab.charAt((t>>>12)&63));s.push(p);s.push(p);break}return s.join("")};Orbited.base64.decode=function(str){var s=str.split("");var out=[];var l=s.length;var tl=0;while(s[--l]==p){++tl}for(var i=0;i<l;){var t=tab.indexOf(s[i++])<<18;if(i<=l){t|=tab.indexOf(s[i++])<<12}if(i<=l){t|=tab.indexOf(s[i++])<<6}if(i<=l){t|=tab.indexOf(s[i++])}out.push(String.fromCharCode((t>>>16)&255));out.push(String.fromCharCode((t>>>8)&255));out.push(String.fromCharCode(t&255))}while(tl--){out.pop()}return out.join("")}})();Orbited.loggers={};Orbited.Loggers={};Orbited.util.loggingSystem=null;if(window.Log4js){Orbited.util.loggingSystem="log4js"}else{if(window.console&&console.firebug&&console.firebug!="1.3.0"){Orbited.util.loggingSystem="firebug"}}Orbited.getLogger=function(name){if(!Orbited.loggers[name]){var logger=null;switch(Orbited.util.loggingSystem){case"firebug":logger=new Orbited.Loggers.FirebugLogger(name);break;case"log4js":logger=new Orbited.Loggers.Log4jsLogger(name);break;default:logger=new Orbited.Loggers.PageLogger(name);break}Orbited.loggers[name]=logger}return Orbited.loggers[name]};Orbited.Loggers.FirebugLogger=function(name){var self=this;self.name=name;self.enabled=false;var padArgs=function(args){var newArgs=[name+":"];for(var i=0;i<args.length;++i){newArgs.push(args[i])}return newArgs};self.log=function(){if(!self.enabled){return}console.log.apply(this,padArgs(arguments))};self.debug=function(){if(!self.enabled){return}console.debug.apply(this,padArgs(arguments))};self.info=function(){if(!self.enabled){return}console.info.apply(this,padArgs(arguments))};self.warn=function(){if(!self.enabled){return}console.warn.apply(this,padArgs(arguments))};self.error=function(){if(!self.enabled){return}console.error.apply(this,padArgs(arguments))};self.assert=function(){if(!self.enabled){return}var newArgs=[arguments[0],name+":"];for(var i=1;i<arguments.length;++i){newArgs.push(arguments[i])}console.assert.apply(this,newArgs)};self.trace=function(){if(!self.enabled){return}console.trace.apply(this,padArgs(arguments))}};Orbited.singleton.pageLoggerPane=null;Orbited.Loggers.PageLogger=function(name){var self=this;self.enabled=false;self.name=name;var checkPane=function(){if(!Orbited.singleton.pageLoggerPane){var p=document.createElement("div");p.border="1px solid black";if(Orbited.settings.pageLoggerHeight){p.style.height=Orbited.settings.pageLoggerHeight}if(Orbited.settings.pageLoggerWidth){p.style.height=Orbited.settings.pageLoggerWidth}p.style.overflow="scroll";document.body.appendChild(p);Orbited.singleton.pageLoggerPane=p}};var show=function(data){checkPane();var d=document.createElement("div");d.innerHTML=data;Orbited.singleton.pageLoggerPane.appendChild(d);Orbited.singleton.pageLoggerPane.scrollTop=Orbited.singleton.pageLoggerPane.scrollHeight};self.log=function(){if(!self.enabled){return}var newArgs=["log",new Date(),"debug","<b>"+name+"</b>"];for(var i=0;i<arguments.length;++i){newArgs.push(arguments[i])}show(newArgs.join(", "))};self.debug=function(){if(!self.enabled){return}var newArgs=[new Date(),"debug","<b>"+name+"</b>"];for(var i=0;i<arguments.length;++i){newArgs.push(arguments[i])}show(newArgs.join(", "))};self.info=function(){if(!self.enabled){return}var newArgs=[new Date(),"info","<b>"+name+"</b>"];for(var i=0;i<arguments.length;++i){newArgs.push(arguments[i])}show(newArgs.join(", "))};self.warn=function(){};self.error=function(){};self.assert=function(){};self.trace=function(){}};Orbited.Loggers.Log4jsLogger=function(name){var self=this;self.name=name;var log4jsName=name;while(log4jsName.indexOf(".")!=-1){log4jsName=log4jsName.replace(".","_")}var logger=Log4js.getLogger(log4jsName);self.logger=logger;logger.setLevel(Log4js.Level.OFF);var generateOutput=function(args){var newArgs=[name+":"];for(var i=0;i<args.length;++i){newArgs.push(args[i])}return newArgs.join(" ")};self.setLevel=function(level){logger.setLevel(level)};self.addAppender=function(a){logger.addAppender(a)};self.log=function(){logger.info(generateOutput(arguments))};self.debug=function(){logger.debug(generateOutput(arguments))};self.info=function(){logger.info(generateOutput(arguments))};self.warn=function(){logger.warn(generateOutput(arguments))};self.error=function(){logger.error(generateOutput(arguments))};self.assert=function(){};self.trace=function(){}};Orbited.system=Orbited.getLogger("system");Orbited.CometTransports={};Orbited.util.chooseTransport=function(){if(Orbited.settings.streaming==false||Orbited.util.browser=="webkit"){return Orbited.CometTransports.LongPoll}var choices=[];for(var name in Orbited.CometTransports){var transport=Orbited.CometTransports[name];if(typeof(transport[Orbited.util.browser])=="number"){Orbited.system.log("viable transport: ",name);choices.push(transport)}}return choices[0]};var createXHR=function(){try{return new XMLHttpRequest()}catch(e){}try{return new ActiveXObject("MSXML3.XMLHTTP")}catch(e){}try{return new ActiveXObject("MSXML2.XMLHTTP.3.0")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(e){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}throw new Error("Could not find XMLHttpRequest or an alternative.")};Orbited.legacy={};Orbited.CometSession=function(){var self=this;self.readyState=self.READY_STATE_INITIALIZED;self.onopen=function(){};self.onread=function(){};self.onclose=function(){};var sessionUrl=null;var sessionKey=null;var sendQueue=[];var packetCount=0;var xhr=null;var handshakeTimer=null;var cometTransport=null;var pingInterval=30000;var pingTimeout=30000;var timeoutTimer=null;var lastPacketId=0;var sending=false;var xsdClose=null;var hardClose=function(){var tdata=encodePackets([[++packetCount,"close"]]);if(xsdClose){xsdClose.contentWindow.sendCloseFrame(sessionUrl.render(),tdata)}else{xhr.open("POST",sessionUrl.render(),!sessionUrl.isSameDomain(location.href));xhr.send(tdata)}};self.open=function(_url){self.logger.debug("open");self.readyState=self.READY_STATE_OPENING;sessionUrl=new Orbited.URL(_url);if(sessionUrl.isSameDomain(location.href)){xhr=createXHR()}else{xhr=new Orbited.XSDR();if(sessionUrl.isSamePort(location.href)){xsdClose=document.createElement("iframe");xsdClose.style.display="block";xsdClose.style.width="0";xsdClose.style.height="0";xsdClose.style.border="0";xsdClose.style.margin="0";xsdClose.style.padding="0";xsdClose.style.overflow="hidden";xsdClose.style.visibility="hidden";var ifUrl=new Orbited.URL("");ifUrl.protocol=Orbited.settings.protocol;ifUrl.domain=Orbited.settings.hostname;ifUrl.port=Orbited.settings.port;ifUrl.path="/static/xsdClose.html";ifUrl.hash=document.domain;xsdClose.src=ifUrl.render();document.body.appendChild(xsdClose)}}if(Orbited.settings.enableFFPrivileges){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead")}catch(ex){}}xhr.open("GET",_url,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status==200){sessionKey=xhr.responseText;self.logger.debug("session key is: ",sessionKey);resetTimeout();if(sessionUrl.path[sessionUrl.path.length]!="/"){sessionUrl.path+="/"}sessionUrl.path+=sessionKey;var transportClass=Orbited.util.chooseTransport();cometTransport=new transportClass();cometTransport.timeoutResetter=resetTimeout;cometTransport.isSubDomain=sessionUrl.isSubDomain(location.href);cometTransport.onReadFrame=transportOnReadFrame;cometTransport.onclose=transportOnClose;cometTransport.connect(sessionUrl.render())}else{xhr=null;self.readyState=self.READY_STATE_CLOSED;self.onclose(Orbited.Errors.InvalidHandshake)}}};xhr.send(null)};self.send=function(data){self.logger.debug("send",data);if(self.readyState!=self.READY_STATE_OPEN){throw new Error("Invalid readyState")}data=Orbited.base64.encode(data);sendQueue.push([++packetCount,"data",data]);self.logger.debug("sending ==",sending);if(!sending){self.logger.debug("starting send");doSend()}};self.close=function(){switch(self.readyState){case self.READY_STATE_CLOSING:case self.READY_STATE_CLOSED:return;case self.READY_STATE_INITIALIZED:self.readyState=self.READY_STATE_CLOSED;return;default:break}self.readyState=self.READY_STATE_CLOSING;sendQueue.push([++packetCount,"close"]);if(!sending){doSend()}};self.reset=function(){self.logger.debug("reset");var origState=self.readyState;self.readyState=self.READY_STATE_CLOSED;switch(origState){case self.READY_STATE_INITIALIZED:self.onclose(Orbited.Errors.UserConnectionReset);break;case self.READY_STATE_OPENING:xhr.onreadystatechange=function(){};xhr.abort();self.onclose(Orbited.Errors.UserConnectionReset);break;case self.READY_STATE_OPEN:self.sendQueue=[];self.sending=false;if(xhr.readyState<4){xhr.onreadystatechange=function(){};xhr.abort()}doClose(Orbited.Errors.UserConnectionReset);hardClose();break;case self.READY_STATE_CLOSING:break;case self.READY_STATE_CLOSED:break}};self.cleanup=function(){self.readyState=self.READY_STATE_CLOSED;cometTransport.close()};var transportOnReadFrame=function(frame){self.logger.debug("transportOnReadFrame");self.logger.debug("READ FRAME: ",frame.id,frame.name,frame.data?frame.data.length:"");if(!isNaN(frame.id)){lastPacketId=Math.max(lastPacketId,frame.id)}self.logger.debug(frame);switch(frame.name){case"close":if(self.readyState<self.READY_STATE_CLOSED){doClose(Orbited.Statuses.ServerClosedConnection)}break;case"data":self.logger.debug("base64 decoding "+frame.data.length+" bytes of data");var data=Orbited.base64.decode(frame.data);self.logger.debug("decode complete");self.onread(data);break;case"open":if(self.readyState==self.READY_STATE_OPENING){self.readyState=self.READY_STATE_OPEN;self.logger.debug("Call self.onopen()");self.onopen()}else{}break;case"ping":switch(cometTransport.name){case"longpoll":break;case"poll":break;default:sendQueue.push([++packetCount,"ping",null]);if(!sending){doSend()}break}break;case"opt":var args=frame.data.split(",");switch(args[0]){case"pingTimeout":pingTimeout=parseInt(args[1])*1000;break;case"pingInterval":pingInterval=parseInt(args[1])*1000;break;default:self.logger.warn("unknown opt key",args[0]);break}break}self.logger.debug("resetting timeout from transportOnReadFrame");resetTimeout()};var transportOnClose=function(){self.logger.debug("transportOnClose");if(self.readyState<self.READY_STATE_CLOSED){try{doClose(Orbited.Statuses.ServerClosedConnection)}catch(e){return}}};var encodePackets=function(queue){var output=[];for(var i=0;i<queue.length;++i){var frame=queue[i];for(var j=0;j<frame.length;++j){var arg=frame[j];if(arg==null){arg=""}if(j==frame.length-1){output.push("0")}else{output.push("1")}output.push(arg.toString().length);output.push(",");output.push(arg.toString())}}return output.join("")};var doSend=function(retries){self.logger.debug("in doSend");if(typeof(retries)=="undefined"){retries=0}if(retries*RETRY_INTERVAL>=RETRY_TIMEOUT){doClose(Orbited.Errors.ConnectionTimeout);sending=false;return}if(sendQueue.length==0){self.logger.debug("sendQueue exhausted");sending=false;return}sending=true;self.logger.debug("setting sending=true");var numSent=sendQueue.length;sessionUrl.setQsParameter("ack",lastPacketId);var tdata=encodePackets(sendQueue);self.logger.debug("post",retries,tdata);if(Orbited.settings.enableFFPrivileges){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead")}catch(ex){}}xhr.open("POST",sessionUrl.render(),true);xhr.onreadystatechange=function(){self.logger.debug("doSend onreadystatechange");switch(xhr.readyState){case 4:if(xhr.status==200){resetTimeout();sendQueue.splice(0,numSent);return doSend()}else{window.setTimeout(function(){doSend(++retries)},RETRY_INTERVAL)}break}};xhr.send(tdata)};var doClose=function(code){self.logger.debug("doClose",code);unsetTimeout();self.readyState=self.READY_STATE_CLOSED;if(cometTransport!=null){cometTransport.onReadFrame=function(){};cometTransport.onclose=function(){};cometTransport.close()}self.onclose(code)};var resetTimeout=function(){self.logger.debug("reset Timeout",pingInterval+pingTimeout);unsetTimeout();timeoutTimer=window.setTimeout(timedOut,pingInterval+pingTimeout)};var unsetTimeout=function(){window.clearTimeout(timeoutTimer)};var timedOut=function(){self.logger.debug("timed out!");doClose(Orbited.Errors.ConnectionTimeout)}};Orbited.CometSession.prototype.logger=Orbited.getLogger("Orbited.CometSession");Orbited.CometSession.prototype.READY_STATE_INITIALIZED=1;Orbited.CometSession.prototype.READY_STATE_OPENING=2;Orbited.CometSession.prototype.READY_STATE_OPEN=3;Orbited.CometSession.prototype.READY_STATE_CLOSING=4;Orbited.CometSession.prototype.READY_STATE_CLOSED=5;var currentTCPSocketId=0;var openSockets={};Orbited.test={};Orbited.test.logger=Orbited.getLogger("Orbited.test");Orbited.test.socketcontrol={};Orbited.test.socketcontrol.kill=function(t){Orbited.test.logger.debug("kill ordered for socket:",t);if(openSockets[t.id]){openSockets[t.id](Orbited.Statuses.SocketControlKilled);t=null;Orbited.test.logger.debug("socket killed")}else{Orbited.test.logger.debug("socket not found")}};Orbited.test.stompdispatcher={};Orbited.test.stompdispatcher.send=function(dest,msg){Orbited.test.logger.debug("stompdispatcher dispatching "+msg+" to "+dest);var s=document.createElement("script");s.src="http://"+Orbited.settings.hostname+":"+Orbited.settings.port+"/system/test/stomp?";s.src+="msg="+msg;s.src+="&dest="+dest;document.body.appendChild(s)};Orbited.TCPSocket=function(){var self=this;self.id=++currentTCPSocketId;if(arguments.length>0){throw new Error("TCPSocket() accepts no arguments")}self.readyState=self.READY_STATE_INITIALIZED;self.onopen=function(){};self.onread=function(){};self.onclose=function(){};var onCloseTriggered=false;var buffer="";var session=null;var binary=false;var handshakeState=null;var hostname=null;var port=null;self.open=function(_hostname,_port,isBinary){if(self.readyState!=self.READY_STATE_INITIALIZED){throw new Error("Invalid readyState")}if(_hostname==false){throw new Error("No hostname specified")}if(isNaN(_port)){throw new Error("Invalid port specified")}binary=!!isBinary;self.readyState=self.READY_STATE_OPENING;hostname=_hostname;port=_port;session=new Orbited.CometSession();var sessionUrl=new Orbited.URL("/tcp");sessionUrl.domain=Orbited.settings.hostname;sessionUrl.port=Orbited.settings.port;sessionUrl.protocol=Orbited.settings.protocol;sessionUrl.setQsParameter("nocache",Math.random());session.open(sessionUrl.render());session.onopen=sessionOnOpen;session.onread=sessionOnRead;session.onclose=sessionOnClose;handshakeState="initial"};self.close=function(){if(self.readyState==self.READY_STATE_CLOSED){return}self.readyState=self.READY_STATE_CLOSED;doClose(Orbited.Errors.UserConnectionReset)};self.reset=function(){if(session){session.reset()}};self.send=function(data){if(self.readyState!=self.READY_STATE_OPEN){throw new Error("Invalid readyState")}if(!binary){data=Orbited.utf8.encode(data)}self.logger.debug("SEND: ",data);session.send(data)};var process=function(){var result=Orbited.utf8.decode(buffer);var data=result[0];var i=result[1];buffer=buffer.slice(i);if(data.length>0){window.setTimeout(function(){self.onread(data)},0)}};var sessionOnRead=function(data){switch(self.readyState){case self.READY_STATE_OPEN:self.logger.debug("READ: ",data);if(binary){window.setTimeout(function(){self.onread(data)},0)}else{self.logger.debug("start buffer size:",buffer.length);buffer+=data;process();self.logger.debug("end buffer size:",buffer.length)}break;case self.READY_STATE_OPENING:switch(handshakeState){case"initial":data=Orbited.utf8.decode(data)[0];self.logger.debug("initial");self.logger.debug("data",data);self.logger.debug("len",data.length);self.logger.debug("typeof(data)",typeof(data));self.logger.debug("data[0] ",data.slice(0,1));self.logger.debug("type ",typeof(data.slice(0,1)));var result=(data.slice(0,1)=="1");self.logger.debug("result",result);if(!result){self.logger.debug("!result");var errorCode=data.slice(1,4);doClose(parseInt(errorCode))}if(result){self.readyState=self.READY_STATE_OPEN;self.logger.debug("tcpsocket.onopen..");self.onopen();self.logger.debug("did onopen")}break}break}};var doClose=function(code){self.logger.debug("doClose",code);if(session){if(code==Orbited.Statuses.ServerClosedConnection||code==Orbited.Errors.Unauthorized||code==Orbited.Errors.RemoteConnectionFailed){session.cleanup()}else{sessionOnClose=function(){};session.close()}session=null}self.logger.debug("onCloseTriggered",onCloseTriggered);if(!onCloseTriggered){self.logger.debug("triggerClose timer",code);onCloseTriggered=true;window.setTimeout(function(){self.logger.debug("onclose!",code);self.onclose(code)},0)}};openSockets[self.id]=doClose;var sessionOnOpen=function(data){var payload=hostname+":"+port+"\n";self.logger.debug("sessionOpen; sending:",payload);payload=Orbited.utf8.encode(payload);self.logger.debug("encoded payload:",payload);X=payload;session.send(payload);handshakeState="initial"};var sessionOnClose=function(code){self.logger.debug("sessionOnClose");doClose(code)}};Orbited.TCPSocket.prototype.toString=function(){return"<Orbited.TCPSocket "+this.id+">"};Orbited.TCPSocket.prototype.logger=Orbited.getLogger("Orbited.TCPSocket");Orbited.TCPSocket.prototype.READY_STATE_INITIALIZED=1;Orbited.TCPSocket.prototype.READY_STATE_OPENING=2;Orbited.TCPSocket.prototype.READY_STATE_OPEN=3;Orbited.TCPSocket.prototype.READY_STATE_CLOSING=4;Orbited.TCPSocket.prototype.READY_STATE_CLOSED=5;Orbited.singleton.XSDR={receiveCbs:{},queues:{},iframes:{},id:0,register:function(receive,queue){var id=++Orbited.singleton.XSDR.id;Orbited.singleton.XSDR.receiveCbs[id]=receive;Orbited.singleton.XSDR.queues[id]=queue;Orbited.system.debug("id is",id);return id}};Orbited.XSDR=function(){var self=this;var ifr=null;var url;var method;var data;var requestHeaders;var queue=[];var id=Orbited.singleton.XSDR.register(function(data){receive(data)},queue);var bridgeUrl=new Orbited.URL("");bridgeUrl.domain=Orbited.settings.hostname;bridgeUrl.port=Orbited.settings.port;bridgeUrl.path="/static/xsdrBridge.html";bridgeUrl.hash=id.toString();bridgeUrl.protocol=Orbited.settings.protocol;self.logger.debug("bridgeUrl.hash is",bridgeUrl.hash);self.logger.debug("bridgeUrl.path is",bridgeUrl.path);self.logger.debug("bridgeUrl is",bridgeUrl.render());var reset=function(){self.responseText="";self.status=null;self.readyState=0;url=null;method=null;data=null;requestHeaders={}};reset();self.onreadystatechange=function(){};self.open=function(_method,_url,async){if(self.readyState==4){reset()}if(self.readyState!=0){throw new Error("Invalid readyState")}if(!async){throw new Error("Only Async XSDR supported")}self.logger.debug("open",_method,_url,async);self.readyState=1;url=_url;method=_method};self.send=function(data){if(self.readyState!=1){throw new Error("Invalid readyState")}self.logger.debug("send",data);if(!ifr){self.logger.debug("creating iframe");ifr=document.createElement("iframe");hideIframe(ifr);ifr.src=bridgeUrl.render();self.logger.debug("set ifr.src to",ifr.src);document.body.appendChild(ifr);Orbited.singleton.XSDR.iframes[id]=ifr}else{queue.push([method,url,data,requestHeaders])}};self.abort=function(){if(self.readyState>0&&self.readyState<4){self.logger.debug("ABORT called");ifr.src="about:blank";document.body.removeChild(ifr);ifr=null;self.readyState=4;self.onreadystatechange()}};self.setRequestHeader=function(key,val){if(self.readyState!=0){throw new Error("Invalid readyState")}requestHeaders[key]=val};self.getResponseHeader=function(){if(self.readyState<2){throw new Error("Invalid readyState")}return responseHeaders[key]};var receive=function(payload){self.logger.debug("received",payload);switch(payload[0]){case"initialized":queue.push([method,url,data,requestHeaders]);self.logger.debug("queue is",queue);self.logger.debug("Orbited.singleton.XSDR.queues[id] is",Orbited.singleton.XSDR.queues[id]);break;case"readystatechange":data=payload[1];self.readyState=data.readyState;self.logger.debug("readystatechange",self.readyState);if(data.status){self.status=data.status;self.logger.debug("status",data.status)}if(data.responseText){self.responseText+=data.responseText;self.logger.debug("responseText",data.responseText)}self.logger.debug("doing trigger");self.onreadystatechange();self.logger.debug("trigger complete");break}};var hideIframe=function(ifr){ifr.style.display="block";ifr.style.width="0";ifr.style.height="0";ifr.style.border="0";ifr.style.margin="0";ifr.style.padding="0";ifr.style.overflow="hidden";ifr.style.visibility="hidden"}};if(Orbited.util.browser=="opera"){var pmLocation=window.postMessage&&"contentWindow"||"document";(window.postMessage&&window||document).addEventListener("message",function(e){var msg=e.data.split(" ");var cmd=msg.shift();if(cmd=="event"){var id=msg.shift();var dataString=msg.join(" ");var data=Orbited.JSON.parse(dataString);Orbited.singleton.XSDR.receiveCbs[id](data)}if(cmd=="queues"){id=msg.shift();var queue=Orbited.singleton.XSDR.queues[id];if(queue.length>0){data=queue.shift();Orbited.singleton.XSDR.iframes[id][pmLocation].postMessage(Orbited.JSON.stringify(data),e.origin)}}},false)}Orbited.XSDR.prototype.logger=Orbited.getLogger("Orbited.XSDR");Orbited.singleton.XSDRBridgeLogger=Orbited.getLogger("XSDRBridge");var CT_READYSTATE_INITIAL=0;var CT_READYSTATE_OPEN=1;var CT_READYSTATE_CLOSED=2;Orbited.CometTransports.XHRStream=function(){var self=this;self.name="xhrstream";var url=null;var xhr=null;var ackId=null;var offset=0;var heartbeatTimer=null;var retryTimer=null;var buffer="";var retryInterval=50;self.readyState=CT_READYSTATE_INITIAL;self.onReadFrame=function(frame){};self.onread=function(packet){self.onReadFrame(packet)};self.onclose=function(){};self.close=function(){if(self.readyState==CT_READYSTATE_CLOSED){return}if(xhr!=null&&(xhr.readyState>1||xhr.readyState<4)){xhr.onreadystatechange=function(){};xhr.abort();xhr=null}self.readyState=CT_READYSTATE_CLOSED;window.clearTimeout(heartbeatTimer);window.clearTimeout(retryTimer);self.onclose()};self.connect=function(_url){if(self.readyState==CT_READYSTATE_OPEN){throw new Error("Already Connected")}url=new Orbited.URL(_url);if(xhr==null){if(url.isSameDomain(location.href)){xhr=createXHR()}else{xhr=new Orbited.XSDR()}}url.path+="/xhrstream";self.readyState=CT_READYSTATE_OPEN;open()};var open=function(){try{if(typeof(ackId)=="number"){url.setQsParameter("ack",ackId)}if(typeof(xhr)=="undefined"||xhr==null){throw new Error("how did this happen?")}if(Orbited.settings.enableFFPrivileges){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead")}catch(ex){}}xhr.open("GET",url.render(),true);xhr.onreadystatechange=function(){self.logger.debug(xhr.readyState);if(self.readyState==CT_READYSTATE_CLOSED){return}switch(xhr.readyState){case 2:try{var status=xhr.status}catch(e){return}if(status==200){try{heartbeatTimer=window.setTimeout(heartbeatTimeout,Orbited.settings.HEARTBEAT_TIMEOUT)}catch(e){self.close();return}var testtimer=heartbeatTimer}break;case 3:try{var status=xhr.status}catch(e){return}if(status==200){retryInterval=50;process()}break;case 4:var doReconnect=true;try{if(xhr.status===null){doReconnect=true}else{doReconnect=false}}catch(e){}if(doReconnect){retryInterval*=2;window.clearTimeout(heartbeatTimer);retryTimer=window.setTimeout(reconnect,retryInterval);return}switch(xhr.status){case 200:process();offset=0;setTimeout(open,0);window.clearTimeout(heartbeatTimer);break;case 404:self.close();break;default:self.close();break}break}};xhr.send(null)}catch(e){self.close()}};var reconnect=function(){self.logger.debug("reconnect...");if(xhr.readyState<4&&xhr.readyState>0){xhr.onreadystatechange=function(){if(xhr.readyState==4){reconnect()}};self.logger.debug("do abort..");xhr.abort();window.clearTimeout(heartbeatTimer)}else{self.logger.debug("reconnect do open");offset=0;setTimeout(open,0)}};var commaPos=-1;var argEnd=null;var frame=[];var process=function(){var stream=xhr.responseText;receivedHeartbeat();while(stream[offset]==" "){offset+=1}while(stream[offset]=="x"){offset+=1}var k=0;while(true){k+=1;if(k>2000){throw new Error("Borked XHRStream transport")}if(commaPos==-1){commaPos=stream.indexOf(",",offset)}if(commaPos==-1){return}if(argEnd==null){argSize=parseInt(stream.slice(offset+1,commaPos));argEnd=commaPos+1+argSize}if(stream.length<argEnd){return}var data=stream.slice(commaPos+1,argEnd);frame.push(data);var isLast=(stream.charAt(offset)=="0");offset=argEnd;argEnd=null;commaPos=-1;if(isLast){var frameCopy=frame;frame=[];receivedPacket(frameCopy)}}};var receivedHeartbeat=function(){window.clearTimeout(heartbeatTimer);self.logger.debug("clearing heartbeatTimer",heartbeatTimer);try{heartbeatTimer=window.setTimeout(function(){self.logger.debug("timer",testtimer,"did it");heartbeatTimeout()},Orbited.settings.HEARTBEAT_TIMEOUT)}catch(e){return}var testtimer=heartbeatTimer;self.logger.debug("heartbeatTimer is now",heartbeatTimer)};var heartbeatTimeout=function(){self.logger.debug("heartbeat timeout... reconnect");reconnect()};var receivedPacket=function(args){var testAckId=parseInt(args[0]);if(!isNaN(testAckId)){ackId=testAckId}var packet={id:testAckId,name:args[1],data:args[2]};self.onread(packet)}};Orbited.CometTransports.XHRStream.prototype.logger=Orbited.getLogger("Orbited.CometTransports.XHRStream");Orbited.CometTransports.XHRStream.firefox=1;Orbited.CometTransports.XHRStream.firefox2=1;Orbited.CometTransports.XHRStream.firefox3=1;Orbited.CometTransports.XHRStream.safari2=1;Orbited.CometTransports.XHRStream.safari3=1;Orbited.CometTransports.LongPoll=function(){var self=this;self.name="longpoll";var url=null;var xhr=null;var ackId=null;var retryTimer=null;var buffer="";var retryInterval=50;self.readyState=CT_READYSTATE_INITIAL;self.onReadFrame=function(frame){};self.onclose=function(){};self.close=function(){self.logger.debug("close");if(self.readyState==CT_READYSTATE_CLOSED){return}if(xhr!=null&&(xhr.readyState>1||xhr.readyState<4)){xhr.onreadystatechange=function(){};xhr.abort();xhr=null}self.logger.debug("close! self.readyState now is 2");self.readyState=CT_READYSTATE_CLOSED;window.clearTimeout(retryTimer);self.onclose()};self.connect=function(_url){self.logger.debug("connect");if(self.readyState==CT_READYSTATE_OPEN){throw new Error("Already Connected")}url=new Orbited.URL(_url);if(xhr==null){if(url.isSameDomain(location.href)){xhr=createXHR()}else{xhr=new Orbited.XSDR()}}url.path+="/longpoll";self.readyState=CT_READYSTATE_OPEN;open()};var open=function(){self.logger.debug("open... self.readyState = "+self.readyState);if(self.readyState==CT_READYSTATE_CLOSED){return}try{if(typeof(ackId)=="number"){url.setQsParameter("ack",ackId)}if(typeof(xhr)=="undefined"||xhr==null){throw new Error("how did this happen?")}if(Orbited.settings.enableFFPrivileges){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead")}catch(ex){}}xhr.open("GET",url.render(),true);xhr.onreadystatechange=function(){self.logger.debug("readystate",xhr.readyState);switch(xhr.readyState){case 4:try{var test=xhr.status}catch(e){self.logger.debug("start reconnect Timer (couldn't access xhr.status)");retryInterval*=2;window.setTimeout(reconnect,retryInterval);return}switch(xhr.status){case 200:self.timeoutResetter();process();self.logger.debug("completed request, reconnect immediately");setTimeout(open,0);break;case 404:self.close();break;case null:retryInterval*=2;self.logger.debug("start reconnect Timer (null xhr.status)");window.setTimeout(reconnect,retryInterval);break;default:self.logger.debug("something broke, xhr.status=",xhr.status);self.close();break}break}};xhr.send(null)}catch(e){self.close()}};var reconnect=function(){self.logger.debug("reconnect...");if(xhr.readyState<4&&xhr.readyState>0){xhr.onreadystatechange=function(){if(xhr.readyState==4){reconnect()}};self.logger.debug("do abort..");xhr.abort();window.clearTimeout(heartbeatTimer)}else{self.logger.debug("reconnect do open");offset=0;setTimeout(open,0)}};var process=function(){self.logger.debug("process");var commaPos=-1;var argEnd=null;var argSize;var frame=[];var stream=xhr.responseText;var offset=0;var k=0;while(true){k+=1;if(k>2000){throw new Error("Borked XHRStream transport")}if(commaPos==-1){commaPos=stream.indexOf(",",offset)}if(commaPos==-1){self.logger.debug("no more commas. offset:",offset,"stream.length:",stream.length);return}if(argEnd==null){argSize=parseInt(stream.slice(offset+1,commaPos));argEnd=commaPos+1+argSize}self.logger.assert(true);var data=stream.slice(commaPos+1,argEnd);self.logger.assert(data.length==argSize,"argSize:",argSize,"data.length",data.length);if(data.length!=argSize){DEBUGDATA=stream}frame.push(data);var isLast=(stream.charAt(offset)=="0");offset=argEnd;argEnd=null;commaPos=-1;if(isLast){var frameCopy=frame;frame=[];receivedPacket(frameCopy)}}};var receivedPacket=function(args){var testAckId=parseInt(args[0]);self.logger.debug("args",args);if(!isNaN(testAckId)){ackId=testAckId}self.logger.debug("testAckId",testAckId,"ackId",ackId);var packet={id:testAckId,name:args[1],data:args[2]};self.onReadFrame(packet)}};Orbited.CometTransports.LongPoll.prototype.logger=Orbited.getLogger("Orbited.CometTransports.LongPoll");Orbited.CometTransports.Poll=function(){var self=this;self.name="poll";var url=null;var xhr=null;var ackId=null;var retryTimer=null;var buffer="";var baseRetryInterval=Orbited.settings.POLL_INTERVAL;var retryInterval=baseRetryInterval;self.readyState=CT_READYSTATE_INITIAL;self.onReadFrame=function(frame){};self.onclose=function(){};self.close=function(){self.logger.debug("close...");if(self.readyState==CT_READYSTATE_CLOSED){return}if(xhr!=null&&(xhr.readyState>1||xhr.readyState<4)){xhr.onreadystatechange=function(){};xhr.abort();xhr=null}self.readyState=CT_READYSTATE_CLOSED;window.clearTimeout(retryTimer);self.onclose()};self.connect=function(_url){self.logger.debug("connect...");if(self.readyState==CT_READYSTATE_OPEN){throw new Error("Already Connected")}url=new Orbited.URL(_url);if(xhr==null){if(url.isSameDomain(location.href)){xhr=createXHR()}else{xhr=new Orbited.XSDR()}}url.path+="/poll";self.readyState=CT_READYSTATE_OPEN;open()};var open=function(){self.logger.debug("open...");try{if(typeof(ackId)=="number"){url.setQsParameter("ack",ackId)}if(typeof(xhr)=="undefined"||xhr==null){throw new Error("how did this happen?")}if(Orbited.settings.enableFFPrivileges){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead")}catch(ex){}}xhr.open("GET",url.render(),true);xhr.onreadystatechange=function(){switch(xhr.readyState){case 4:try{var test=xhr.status}catch(e){retryInterval*=2;window.setTimeout(reconnect,retryInterval);return}switch(xhr.status){case 200:self.timeoutResetter();retryInterval=baseRetryInterval;process();setTimeout(open,retryInterval);break;case 404:self.close();break;case null:retryInterval*=2;window.setTimeout(reconnect,retryInterval);break;default:self.close();break}break}};xhr.send(null)}catch(e){self.close()}};var reconnect=function(){self.logger.debug("reconnect...");if(xhr.readyState<4&&xhr.readyState>0){xhr.onreadystatechange=function(){if(xhr.readyState==4){reconnect()}};self.logger.debug("do abort..");xhr.abort();window.clearTimeout(heartbeatTimer)}else{self.logger.debug("reconnect do open");offset=0;setTimeout(open,0)}};var process=function(){self.logger.debug("process...");var commaPos=-1;var argEnd=null;var argSize;var frame=[];var stream=xhr.responseText;var offset=0;var k=0;while(true){k+=1;if(k>2000){throw new Error("Borked XHRStream transport")}if(commaPos==-1){commaPos=stream.indexOf(",",offset)}if(commaPos==-1){self.logger.debug("no more commas. offset:",offset,"stream.length:",stream.length);return}if(argEnd==null){argSize=parseInt(stream.slice(offset+1,commaPos));argEnd=commaPos+1+argSize}var data=stream.slice(commaPos+1,argEnd);self.logger.assert(data.length==argSize,"argSize:",argSize,"data.length",data.length);if(data.length!=argSize){DEBUGDATA=stream}frame.push(data);var isLast=(stream.charAt(offset)=="0");offset=argEnd;argEnd=null;commaPos=-1;if(isLast){var frameCopy=frame;frame=[];receivedPacket(frameCopy)}}};var receivedPacket=function(args){self.logger.debug("receivedPacket...");var testAckId=parseInt(args[0]);self.logger.debug("args",args);if(!isNaN(testAckId)){ackId=testAckId}self.logger.debug("testAckId",testAckId,"ackId",ackId);var packet={id:testAckId,name:args[1],data:args[2]};self.onReadFrame(packet)}};Orbited.CometTransports.Poll.prototype.logger=Orbited.getLogger("Orbited.CometTransports.Poll");Orbited.CometTransports.HTMLFile=function(){var self=this;self.name="htmlfile";var id=++Orbited.singleton.HTMLFile.i;Orbited.singleton.HTMLFile.instances[id]=self;var htmlfile=null;var ifr=null;var url=null;var restartUrl=null;var restartTimer=null;var baseRestartTimeout=2000;var restartTimeout=baseRestartTimeout;self.onReadFrame=function(frame){};self.onread=function(packet){self.onReadFrame(packet)};self.onclose=function(){};self.connect=function(_url){if(self.readyState==CT_READYSTATE_OPEN){throw new Error("Already Connected")}self.logger.debug("self.connect",_url);url=new Orbited.URL(_url);url.path+="/htmlfile";url.setQsParameter("frameID",id.toString());self.readyState=CT_READYSTATE_OPEN;doOpen(url.render())};var doOpenIfr=function(){var ifr=document.createElement("iframe");ifr.src=url.render();document.body.appendChild(ifr)};var doOpen=function(_url){self.logger.debug("doOpen",_url);htmlfile=new ActiveXObject("htmlfile");htmlfile.open();if(self.isSubDomain){htmlfile.write('<html><script>document.domain="'+document.domain+'";<\/script></html>')}else{htmlfile.write("<html></html>")}htmlfile.parentWindow.Orbited=Orbited;htmlfile.close();var iframe_div=htmlfile.createElement("div");htmlfile.body.appendChild(iframe_div);ifr=htmlfile.createElement("iframe");iframe_div.appendChild(ifr);ifr.src=_url;restartUrl=_url;restartTimer=window.setTimeout(reconnect,restartTimeout)};self.restartingStream=function(_url){restartUrl=_url;restartTimer=window.setTimeout(reconnect,restartTimeout)};var reconnect=function(){self.logger.debug("doing reconnect... "+restartTimeout);restartTimeout*=2;ifr.src=restartUrl;restartTimer=window.setTimeout(reconnect,restartTimeout)};self.streamStarted=function(){self.logger.debug("stream started..");window.clearTimeout(restartTimer);restartTimer=null;restartTimeout=baseRestartTimeout};self.streamClosed=function(){self.logger.debug("stream closed!");window.clearTimeout(restartTimer);self.close()};self.receive=function(id,name,data){packet={id:id,name:name,data:data};self.onread(packet)};self.close=function(){if(self.readyState==CT_READYSTATE_CLOSED){return}self.logger.debug("close called, clearing timer");window.clearTimeout(restartTimer);self.readyState=CT_READYSTATE_CLOSED;ifr.src="about:blank";htmlfile=null;CollectGarbage();self.onclose()}};Orbited.CometTransports.HTMLFile.prototype.logger=Orbited.getLogger("Orbited.CometTransports.HTMLFile");Orbited.CometTransports.HTMLFile.ie=1;Orbited.singleton.HTMLFile={i:0,instances:{}};Orbited.CometTransports.SSE=function(){var self=this;self.name="sse";self.onReadFrame=function(frame){};self.onclose=function(){};self.readyState=CT_READYSTATE_INITIAL;var heartbeatTimer=null;var source=null;var url=null;var lastEventId=-1;self.close=function(){if(self.readyState==CT_READYSTATE_CLOSED){return}self.readyState=CT_READYSTATE_CLOSED;doClose();self.onclose()};self.connect=function(_url){if(self.readyState==CT_READYSTATE_OPEN){throw new Error("Already Connected")}url=new Orbited.URL(_url);url.path+="/sse";self.readyState=CT_READYSTATE_OPEN;doOpen()};doClose=function(){source.removeEventSource(source.getAttribute("src"));source.setAttribute("src","");if(opera.version()<9.5){document.body.removeChild(source)}source=null};doOpen=function(){source=document.createElement("event-source");source.setAttribute("src",url.render());if(opera.version()<9.5){document.body.appendChild(source)}source.addEventListener("payload",receivePayload,false)};var receivePayload=function(event){var data=eval(event.data);if(typeof(data)!="undefined"){for(var i=0;i<data.length;++i){var packet=data[i];receive(packet[0],packet[1],packet[2])}}};var receive=function(id,name,data){var tempId=parseInt(id);if(!isNaN(tempId)){lastEventId=tempId}packet={id:id,name:name,data:data};self.onReadFrame(packet)}};Orbited.CometTransports.SSE.prototype.logger=Orbited.getLogger("Orbited.CometTransports.SSE");Orbited.CometTransports.SSE.opera=1;Orbited.CometTransports.SSE.opera8=1;Orbited.CometTransports.SSE.opera9=1;Orbited.CometTransports.SSE.opera9_5=0.8;Orbited.URL=function(_url){var self=this;var protocolIndex=_url.indexOf("://");if(protocolIndex!=-1){self.protocol=_url.slice(0,protocolIndex)}else{protocolIndex=-3}var domainIndex=_url.indexOf("/",protocolIndex+3);if(domainIndex==-1){domainIndex=_url.length}var hashIndex=_url.indexOf("#",domainIndex);if(hashIndex!=-1){self.hash=_url.slice(hashIndex+1)}else{hashIndex=_url.length}var uri=_url.slice(domainIndex,hashIndex);var qsIndex=uri.indexOf("?");if(qsIndex==-1){qsIndex=uri.length}self.path=uri.slice(0,qsIndex);self.qs=uri.slice(qsIndex+1);if(self.path==""){self.path="/"}var domain=_url.slice(protocolIndex+3,domainIndex);var portIndex=domain.indexOf(":");if(portIndex==-1){self.port=80;portIndex=domain.length}else{self.port=parseInt(domain.slice(portIndex+1))}if(isNaN(this.port)){throw new Error("Invalid _url")}self.domain=domain.slice(0,portIndex);self.render=function(){var output="";if(typeof(self.protocol)!="undefined"){output+=self.protocol+"://"}output+=self.domain;if(self.port!=80&&typeof(self.port)!="undefined"&&self.port!=null){if(typeof(self.port)!="string"||self.port.length>0){output+=":"+self.port}}if(typeof(self.path)=="undefined"||self.path==null){output+="/"}else{output+=self.path}if(self.qs.length>0){output+="?"+self.qs}if(typeof(self.hash)!="undefined"&&self.hash.length>0){output+="#"+self.hash}return output};self.isSamePort=function(_url){_url=new Orbited.URL(_url);return _url.port==self.port};self.isSameDomain=function(_url){_url=new Orbited.URL(_url);if(!_url.domain||!self.domain){return true}return(_url.port==self.port&&_url.domain==self.domain)};self.isSameParentDomain=function(_url){_url=new Orbited.URL(_url);if(_url.domain==self.domain){return true}var orig_domain=_url.domain;var parts=document.domain.split(".");for(var i=0;i<parts.length-1;++i){var new_domain=parts.slice(i).join(".");if(orig_domain==new_domain){return true}}return false};self.isSubDomain=function(_url){_url=new Orbited.URL(_url);if(!_url.domain||!self.domain){return false}return(_url.port==self.port&&self.domain.indexOf("."+_url.domain)>0)};var decodeQs=function(qs){if(qs.indexOf("=")==-1){return{}}var result={};var chunks=qs.split("&");for(var i=0;i<chunks.length;++i){var cur=chunks[i];var pieces=cur.split("=");result[pieces[0]]=pieces[1]}return result};var encodeQs=function(o){var output="";for(var key in o){output+="&"+key+"="+o[key]}return output.slice(1)};self.setQsParameter=function(key,val){var curQsObj=decodeQs(self.qs);curQsObj[key]=val;self.qs=encodeQs(curQsObj)};self.mergeQs=function(qs){var newQsObj=decodeQs(qs);for(key in newQsObj){curQsObj[key]=newQsObj[key]}};self.removeQsParameter=function(key){var curQsObj=decodeQs(self.qs);delete curQsObj[key];self.qs=encodeQs(curQsObj)};self.merge=function(targetUrl){if(typeof(self.protocol)!="undefined"&&self.protocol.length>0){self.protocol=targetUrl.protocol}if(targetUrl.domain.length>0){self.domain=targetUrl.domain;self.port=targetUrl.port}self.path=targetUrl.path;self.qs=targetUrl.qs;self.hash=targetUrl.hash}};Orbited.utf8={};Orbited.utf8.decode=function(s){var ret=[];var j=0;function pad6(str){while(str.length<6){str="0"+str}return str}for(var i=0;i<s.length;i++){if((s.charCodeAt(i)&248)==240){if(s.length-j<4){break}j+=4;ret.push(String.fromCharCode(parseInt((s.charCodeAt(i)&7).toString(2)+pad6((s.charCodeAt(i+1)&63).toString(2))+pad6((s.charCodeAt(i+2)&63).toString(2))+pad6((s.charCodeAt(i+3)&63).toString(2)),2)));i+=3}else{if((s.charCodeAt(i)&240)==224){if(s.length-j<3){break}j+=3;ret.push(String.fromCharCode(parseInt((s.charCodeAt(i)&15).toString(2)+pad6((s.charCodeAt(i+1)&63).toString(2))+pad6((s.charCodeAt(i+2)&63).toString(2)),2)));i+=2}else{if((s.charCodeAt(i)&224)==192){if(s.length-j<2){break}j+=2;ret.push(String.fromCharCode(parseInt((s.charCodeAt(i)&31).toString(2)+pad6((s.charCodeAt(i+1)&63).toString(2),6),2)));i+=1}else{j+=1;ret.push(String.fromCharCode(s.charCodeAt(i)))}}}}return[ret.join(""),j]};Orbited.utf8.encode=function(text){var ret=[];function pad(str,len){while(str.length<len){str="0"+str}return str}var e=String.fromCharCode;for(var i=0;i<text.length;i++){var chr=text.charCodeAt(i);if(chr<=127){ret.push(e(chr))}else{if(chr<=2047){var binary=pad(chr.toString(2),11);ret.push(e(parseInt("110"+binary.substr(0,5),2)));ret.push(e(parseInt("10"+binary.substr(5,6),2)))}else{if(chr<=65535){var binary=pad(chr.toString(2),16);ret.push(e(parseInt("1110"+binary.substr(0,4),2)));ret.push(e(parseInt("10"+binary.substr(4,6),2)));ret.push(e(parseInt("10"+binary.substr(10,6),2)))}else{if(chr<=1114111){var binary=pad(chr.toString(2),21);ret.push(e(parseInt("11110"+binary.substr(0,3),2)));ret.push(e(parseInt("10"+binary.substr(3,6),2)));ret.push(e(parseInt("10"+binary.substr(9,6),2)));ret.push(e(parseInt("10"+binary.substr(15,6),2)))}}}}}return ret.join("")};Orbited.JSON=function(){function f(n){return n<10?"0"+n:n}Date.prototype.toJSON=function(key){return this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z"};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf()};var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapeable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapeable.lastIndex=0;return escapeable.test(string)?'"'+string.replace(escapeable,function(a){var c=meta[a];if(typeof c==="string"){return c}return"\\u"+("0000"+(+(a.charCodeAt(0))).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(typeof value.length==="number"&&!(value.propertyIsEnumerable("length"))){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==="string"){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}return{stringify:function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})},parse:function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+(+(a.charCodeAt(0))).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}}()})();(function(){try{var a=document.getElementsByTagName("script");for(var d=0;d<a.length;++d){var b=a[d];if(b.src.match("/static/Orbited.js$")){var c=new Orbited.URL(b.src);if(c.render().indexOf("http")!=0){var c=new Orbited.URL(window.location.toString())}Orbited.settings.hostname=c.domain;Orbited.settings.port=c.port;break}}}catch(f){}})();